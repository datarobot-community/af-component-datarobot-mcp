---
version: '3'

env:
  APPDIR: ./template/{{"{{"}}mcp_app_name{{"}}"}}
  SRCDIR: ./template/{{"{{"}}mcp_app_name{{"}}"}}/app
  TESTDIR: ./template/{{"{{"}}mcp_app_name{{"}}"}}/tests

tasks:
  copy:
    desc: ğŸ”§ Render the template
    cmds:
      - echo "ğŸ”§ Rendering template"
      - rm -rf ./tmp/template
      - uv run copier copy --defaults --overwrite . ./tmp/template
  lint:
    desc: ğŸ§¹ Lint the codebase
    cmds:
      - echo "ğŸ§¹ Linting"
      - uv run ruff format "$SRCDIR"
      - uv run ruff check --fix "$SRCDIR"
      - uv run mypy --pretty "$SRCDIR"

  lint-yaml:
    desc: ğŸ§¹ Lint YAML files
    silent: true
    cmds:
      - echo "ğŸ§¹ Linting YAML files.."
      - |
        if ! command -v yamlfmt >/dev/null 2>&1; then
          echo "âŒ yamlfmt is not installed. Install it via `brew install yamlfmt` or `go install github.com/google/yamlfmt/cmd/yamlfmt@latest`.";
          exit 1;
        fi
      - yamlfmt -conf .yamlfmt.yaml -lint ./tmp/template/

  lint-check:
    desc: ğŸ§¹ Check whether the codebase is linted
    cmds:
      - echo "ğŸ§¹ Linting"
      - uv run ruff format --check --diff "$SRCDIR" --config "$APPDIR"/pyproject.toml "$SRCDIR"
      - uv run ruff check "$SRCDIR" --config "$APPDIR"/pyproject.toml "$SRCDIR"
      - uv run mypy --pretty "$SRCDIR"

  validate-windows-compatibility:
    desc: "Validate that file paths don't contain characters illegal on Windows"
    cmds:
      - cmd: |
          offending_files=$(find . -type f -exec basename {} \; | grep '[\<\>\:\"\/\|\?\*]' | sort -u)
          if [ -n "$offending_files" ]; then
            echo "Files with Windows-incompatible characters found:"
            for file in $offending_files; do
              find . -type f -name "$file"
            done
            exit 1
          fi
        platforms: [linux, darwin]

  copyright:
    aliases: [license]
    desc: ğŸ“œ Apply license headers
    cmds:
      - echo "ğŸ“œ Applying license headers"
      - docker run  --rm -v $PWD:/github/workspace ghcr.io/apache/skywalking-eyes/license-eye:eb0e0b091ea41213f712f622797e37526ca1e5d6
        -v info -c .licenserc.yaml header fix

  copyright-check:
    aliases: [license-check]
    desc: ğŸ“œ Checking for license headers
    cmds:
      - echo "ğŸ“œ Checking license headers"
      - docker run  --rm -v $PWD:/github/workspace ghcr.io/apache/skywalking-eyes/license-eye:eb0e0b091ea41213f712f622797e37526ca1e5d6
        -v info -c .licenserc.yaml header check
