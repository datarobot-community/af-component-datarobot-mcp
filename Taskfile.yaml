---
version: '3'

env:
  APPDIR: ./template/{{"{{"}}mcp_app_name{{"}}"}}
  SRCDIR: ./template/{{"{{"}}mcp_app_name{{"}}"}}/app
  TESTDIR: ./template/{{"{{"}}mcp_app_name{{"}}"}}/tests

tasks:
  copy:
    desc: ğŸ”§ Render the template
    cmds:
      - echo "ğŸ”§ Rendering template"
      - rm -rf ./tmp/template
      - uv run copier copy --defaults --overwrite . ./tmp/template
  lint:
    desc: ğŸ§¹ Lint the codebase
    cmds:
      - echo "ğŸ§¹ Linting"
      - uv run ruff format "$SRCDIR"
      - uv run ruff check --fix "$SRCDIR"
      - uv run mypy --pretty "$SRCDIR"

  lint-yaml:
    desc: ğŸ§¹ Lint YAML files
    silent: true
    cmds:
      - echo "ğŸ§¹ Linting YAML files.."
      - |
        if ! command -v yamlfmt >/dev/null 2>&1; then
          echo "âŒ yamlfmt is not installed. Install it via `brew install yamlfmt` or `go install github.com/google/yamlfmt/cmd/yamlfmt@latest`.";
          exit 1;
        fi
      - yamlfmt -conf .yamlfmt.yaml -lint ./tmp/template/

  lint-check:
    desc: ğŸ§¹ Check whether the codebase is linted
    cmds:
      - echo "ğŸ§¹ Linting"
      - uv run ruff format --check --diff "$SRCDIR" --config "$APPDIR"/pyproject.toml "$SRCDIR"
      - uv run ruff check "$SRCDIR" --config "$APPDIR"/pyproject.toml "$SRCDIR"
      - uv run mypy --pretty "$SRCDIR"

  validate-windows-compatibility:
    desc: "Validate that file paths don't contain characters illegal on Windows"
    cmds:
      - cmd: |
          echo "Scanning for Windows-incompatible file names (<>:\"|?*)..."
          total=$(find ./template -type f | wc -l | tr -d ' ')
          failures=$(find ./template -type f | while IFS= read -r f; do
            if echo "$f" | grep -q '[<>:"|?*]'; then
              echo "FAIL: $f" >&2
              echo "$f"
            else
              echo "  ok: $f" >&2
            fi
          done)
          bad=0
          if [ -n "$failures" ]; then
            bad=$(echo "$failures" | wc -l | tr -d ' ')
            echo ""
            echo "Offending files:"
            echo "$failures"
          fi
          echo ""
          echo "Checked $total files, $bad incompatible."
          [ "$bad" -gt 0 ] && exit 1 || true
        platforms: [linux, darwin]

  copyright:
    aliases: [license]
    desc: ğŸ“œ Apply license headers
    cmds:
      - echo "ğŸ“œ Applying license headers"
      - docker run  --rm -v $PWD:/github/workspace ghcr.io/apache/skywalking-eyes/license-eye:eb0e0b091ea41213f712f622797e37526ca1e5d6
        -v info -c .licenserc.yaml header fix

  copyright-check:
    aliases: [license-check]
    desc: ğŸ“œ Checking for license headers
    cmds:
      - echo "ğŸ“œ Checking license headers"
      - docker run  --rm -v $PWD:/github/workspace ghcr.io/apache/skywalking-eyes/license-eye:eb0e0b091ea41213f712f622797e37526ca1e5d6
        -v info -c .licenserc.yaml header check
